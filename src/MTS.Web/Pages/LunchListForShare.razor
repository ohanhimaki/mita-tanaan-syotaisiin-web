@using MTS.FetchData
<MudContainer>

  <MudCard>
    @* buttons for every weekday *@

    <MudCardContent>
      @for (var i = 1; i <= 5; i++)
      {
        var day = i;
        <MudButton Variant="Variant.Filled" Color="SelectedDay == day ? Color.Primary : Color.Default" OnClick="() => SelectedDay = day">@GetDayOfWeekFi(day)</MudButton>
      }
    </MudCardContent>
  </MudCard>

  @if (Lists is not null)
  {
    var emojiCount = 1;
    foreach (var lunchListContainer in Lists.Where(x => x.DayNumber == SelectedDay ||x.DayNumber == 999).OrderBy(x => x.RestaurantManagement.nimi))
    {

      var emoji = lunchListContainer.RestaurantManagement.emoji ?? GetEmoji(emojiCount++);
      <MudCard Class="m-4">
        <MudCardContent>

          <MudText Typo="Typo.h2" Color="Color.Primary">@emoji @lunchListContainer.RestaurantManagement.nimi</MudText>
          <br/>
          @((MarkupString)lunchListContainer.DescriptionHtml)
        </MudCardContent>
      </MudCard>
    }
  }
</MudContainer>

@code {

  [Inject]
  HttpClient Http { get; set; }
  public int SelectedDay { get; set; } = 1;

  protected override void OnInitialized()
  {
    SelectedDay = (int)DateTime.Now.DayOfWeek;
    base.OnInitialized();
  }

  protected override Task OnParametersSetAsync()
  {
    if (Lists is null)
    {
      InitializeLists();
    }
    return base.OnParametersSetAsync();
  }

  private async Task InitializeLists()
  {
    Restaurants = await GetRestaurantsFromJson();

    try
    {
      var lists = await LunchListFetcher.GetLunchListAsync(Restaurants);
      Lists = lists;
      await InvokeAsync(StateHasChanged);
    }
    catch (Exception e)
    {
      Console.WriteLine(e);
      throw;
    }
  }

  public List<RestaurantManagement> Restaurants { get; set; }

  private async Task<List<RestaurantManagement>> GetRestaurantsFromJson()
  {
  // return list from restaurants.json wwwroot with httpclient get request


    var list = await Http.GetFromJsonAsync<List<RestaurantManagement>>("/restaurants.json");
    return list;
  }

  public List<LunchListContainer>? Lists { get; set; }


  private string GetEmoji(int i)
  {
    // list of 10 face emojis
    var emojis = new List<string> { "😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇" };
    return emojis[i % 10];
  }

  private string GetDayOfWeekFi(int day)
  {
    return day switch
    {
      1 => "Ma",
      2 => "Ti",
      3 => "Ke",
      4 => "To",
      5 => "Pe",
      _ => "??"
    };
  }

}
